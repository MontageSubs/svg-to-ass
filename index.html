<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG to ASS 1.0</title>
    <style>
        :root {
            --bg-body: #1e1e1e;       /* 深色背景 */
            --bg-panel: #252526;      /* 面板背景 */
            --bg-input: #3c3c3c;      /* 输入框背景 */
            --border: #474747;        /* 边框颜色 */
            --accent: #3794ff;        /* 强调色(蓝) */
            --accent-hover: #1e70d1;
            --text-main: #cccccc;
            --text-dim: #858585;
            --success: #4ec9b0;
            --error: #f44747;
        }

        body {
            font-family: 'Segoe UI', Inter, Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            flex: none;
            gap: 15px;
        }

        .logo-svg {
            height: 40px; 
            width: auto;
            background: transparent !important;
        }
        .logo-svg path[fill="black"]:first-child { display: none; }
        
        h1 { margin: 0; font-size: 20px; font-weight: 500; color: #fff; display: flex; align-items: center; }
        .version { font-size: 12px; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex: 1;
            min-height: 0;
            padding-bottom: 30px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            position: relative;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: none;
        }

        textarea {
            background: var(--bg-input);
            color: #d4d4d4;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: none;
            flex: 1;
            outline: none;
            line-height: 1.5;
        }
        textarea:focus { border-color: var(--accent); }

        #assOutput { color: #9cdcfe; }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #2d2d2d;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            flex: none;
        }

        label { font-size: 12px; color: var(--text-dim); margin-right: 5px; }
        
        input[type="text"], select {
            background: var(--bg-input);
            color: white;
            border: 1px solid var(--border);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }
        input[type="text"] { flex: 1; min-width: 120px; font-family: monospace; }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-primary:active { transform: translateY(0); box-shadow: none; }

        .preview-box {
            height: 180px; 
            flex: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            background-color: #eee;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #ccc 75%), 
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #previewBg {
            position: absolute;
            top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.8);
            z-index: 0;
            pointer-events: none;
            transition: background 0.2s;
        }

        svg.preview-svg {
            z-index: 1;
            max-width: 90%;
            max-height: 90%;
            overflow: visible;
        }

        .author-tag {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.3);
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            pointer-events: none;
            z-index: 0;
        }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            font-size: 13px;
            border: 1px solid #444;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast.success { border-bottom: 2px solid var(--success); }
        #toast.error { border-bottom: 2px solid var(--error); }
        #toast.warn { border-bottom: 2px solid orange; }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; overflow-y: auto; display: block; }
            body { height: auto; min-height: 100vh; overflow-y: auto; }
            .panel { margin-bottom: 20px; height: 500px; }
            textarea { min-height: 200px; }
        }
    </style>
</head>
<body>

    <header>
        <svg class="logo-svg" viewBox="0 0 1920 1080" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_1_2)">
            <path d="M1920 0H0V1080H1920V0Z" fill="black"/>
            <path d="M960 870C1180.91 870 1360 690.914 1360 470C1360 249.086 1180.91 70 960 70C739.086 70 560 249.086 560 470C560 690.914 739.086 870 960 870Z" fill="url(#paint0_radial_1_2)"/>
            <g style="mix-blend-mode:screen">
            <path opacity="0.95" d="M800 342C800 320.667 810.667 310 832 310H960V470H800V342Z" fill="url(#paint1_linear_1_2)"/>
            <path opacity="0.95" d="M960 310H1088C1109.33 310 1120 320.667 1120 342V470H960V310Z" fill="url(#paint2_linear_1_2)"/>
            <path opacity="0.95" d="M960 470H1120V598C1120 619.333 1109.33 630 1088 630H960V470Z" fill="url(#paint3_linear_1_2)"/>
            <path opacity="0.95" d="M800 470H960V630H832C810.667 630 800 619.333 800 598V470Z" fill="url(#paint4_linear_1_2)"/>
            </g>
            <path d="M931 420L1021 470L931 520V420Z" fill="black"/>
            <path d="M682.886 690.273V795H663.761L618.199 729.085H617.432V795H595.29V690.273H614.722L659.926 756.136H660.847V690.273H682.886ZM723.322 690.273V795H701.18V690.273H723.322ZM833.943 726.938H811.545C811.136 724.04 810.301 721.466 809.04 719.216C807.778 716.932 806.159 714.989 804.182 713.386C802.205 711.784 799.92 710.557 797.33 709.705C794.773 708.852 791.994 708.426 788.994 708.426C783.574 708.426 778.852 709.773 774.83 712.466C770.807 715.125 767.688 719.011 765.472 724.125C763.256 729.205 762.148 735.375 762.148 742.636C762.148 750.102 763.256 756.375 765.472 761.455C767.722 766.534 770.858 770.369 774.881 772.96C778.903 775.551 783.557 776.847 788.841 776.847C791.807 776.847 794.551 776.455 797.074 775.67C799.631 774.886 801.898 773.744 803.875 772.244C805.852 770.71 807.489 768.852 808.784 766.67C810.114 764.489 811.034 762 811.545 759.205L833.943 759.307C833.364 764.114 831.915 768.75 829.597 773.216C827.313 777.648 824.227 781.619 820.341 785.131C816.489 788.608 811.886 791.369 806.534 793.415C801.216 795.426 795.199 796.432 788.483 796.432C779.142 796.432 770.79 794.318 763.426 790.091C756.097 785.864 750.301 779.744 746.04 771.733C741.812 763.722 739.699 754.023 739.699 742.636C739.699 731.216 741.847 721.5 746.142 713.489C750.438 705.477 756.267 699.375 763.631 695.182C770.994 690.955 779.278 688.841 788.483 688.841C794.551 688.841 800.176 689.693 805.358 691.398C810.574 693.102 815.193 695.591 819.216 698.864C823.239 702.102 826.511 706.074 829.034 710.778C831.591 715.483 833.227 720.869 833.943 726.938ZM849.821 795V690.273H871.963V736.449H873.344L911.031 690.273H937.571L898.707 737.165L938.031 795H911.543L882.855 751.943L871.963 765.239V795H849.821Z" fill="white"/>
            <path d="M1028.48 762H1022.14C1021.76 760.176 1021.11 758.574 1020.17 757.193C1019.25 755.812 1018.12 754.653 1016.79 753.716C1015.48 752.761 1014.02 752.045 1012.42 751.568C1010.82 751.091 1009.15 750.852 1007.41 750.852C1004.24 750.852 1001.37 751.653 998.793 753.256C996.236 754.858 994.199 757.219 992.682 760.338C991.182 763.457 990.432 767.284 990.432 771.818C990.432 776.352 991.182 780.179 992.682 783.298C994.199 786.418 996.236 788.778 998.793 790.381C1001.37 791.983 1004.24 792.784 1007.41 792.784C1009.15 792.784 1010.82 792.545 1012.42 792.068C1014.02 791.591 1015.48 790.884 1016.79 789.946C1018.12 788.991 1019.25 787.824 1020.17 786.443C1021.11 785.045 1021.76 783.443 1022.14 781.636H1028.48C1028 784.312 1027.13 786.707 1025.87 788.821C1024.61 790.935 1023.04 792.733 1021.16 794.216C1019.29 795.682 1017.18 796.798 1014.85 797.625C1012.53 798.332 1010.05 798.716 1007.41 798.716C1002.94 798.716 998.972 797.625 995.494 795.443C992.017 793.261 989.281 790.159 987.287 786.136C985.293 782.114 984.295 777.341 984.295 771.818C984.295 766.295 985.293 761.523 987.287 757.5C989.281 753.477 992.017 750.375 995.494 748.193C998.972 746.011 1002.94 744.92 1007.41 744.92C1010.05 744.92 1012.53 745.304 1014.85 746.071C1017.18 746.838 1019.29 747.963 1021.16 749.446C1023.04 750.912 1024.61 752.702 1025.87 754.815C1027.13 756.912 1028 759.307 1028.48 762ZM1082.91 771.818C1082.91 777.341 1081.91 782.114 1079.91 786.136C1077.92 790.159 1075.18 793.261 1071.71 795.443C1068.23 797.625 1064.26 798.716 1059.79 798.716C1055.33 798.716 1051.35 797.625 1047.88 795.443C1044.4 793.261 1041.66 790.159 1039.67 786.136C1037.68 782.114 1036.68 777.341 1036.68 771.818C1036.68 766.295 1037.68 761.523 1039.67 757.5C1041.66 753.477 1044.4 750.375 1047.88 748.193C1051.35 746.011 1055.33 744.92 1059.79 744.92C1064.26 744.92 1068.23 746.011 1071.71 748.193C1075.18 750.375 1077.92 753.477 1079.91 757.5C1081.91 761.523 1082.91 766.295 1082.91 771.818ZM1076.77 771.818C1076.77 767.284 1076.01 763.457 1074.49 760.338C1072.99 757.219 1070.96 754.858 1068.38 753.256C1065.83 751.653 1062.96 750.852 1059.79 750.852C1056.62 750.852 1053.75 751.653 1051.18 753.256C1048.62 754.858 1046.58 757.219 1045.06 760.338C1043.56 763.457 1042.81 767.284 1042.81 771.818C1042.81 776.352 1043.56 780.179 1045.06 783.298C1046.58 786.418 1048.62 788.778 1051.18 790.381C1053.75 791.983 1056.62 792.784 1059.79 792.784C1062.96 792.784 1065.83 791.983 1068.38 790.381C1070.96 788.778 1072.99 786.418 1074.49 783.298C1076.01 780.179 1076.77 776.352 1076.77 771.818ZM1093.57 798V745.636H1099.91V792.375H1124.25V798H1093.57ZM1134.07 798V745.636H1140.41V792.375H1164.75V798H1134.07ZM1174.57 798V745.636H1206.17V751.261H1180.91V768.955H1204.53V774.58H1180.91V792.375H1206.58V798H1174.57ZM1259.74 762H1253.39C1253.02 760.176 1252.36 758.574 1251.43 757.193C1250.5 755.812 1249.38 754.653 1248.05 753.716C1246.74 752.761 1245.28 752.045 1243.68 751.568C1242.08 751.091 1240.41 750.852 1238.67 750.852C1235.5 750.852 1232.62 751.653 1230.05 753.256C1227.49 754.858 1225.46 757.219 1223.94 760.338C1222.44 763.457 1221.69 767.284 1221.69 771.818C1221.69 776.352 1222.44 780.179 1223.94 783.298C1225.46 786.418 1227.49 788.778 1230.05 790.381C1232.62 791.983 1235.5 792.784 1238.67 792.784C1240.41 792.784 1242.08 792.545 1243.68 792.068C1245.28 791.591 1246.74 790.884 1248.05 789.946C1249.38 788.991 1250.5 787.824 1251.43 786.443C1252.36 785.045 1253.02 783.443 1253.39 781.636H1259.74C1259.26 784.312 1258.39 786.707 1257.13 788.821C1255.87 790.935 1254.3 792.733 1252.42 794.216C1250.55 795.682 1248.44 796.798 1246.11 797.565C1243.79 798.332 1241.31 798.716 1238.67 798.716C1234.2 798.716 1230.23 797.625 1226.75 795.443C1223.27 793.261 1220.54 790.159 1218.54 786.136C1216.55 782.114 1215.55 777.341 1215.55 771.818C1215.55 766.295 1216.55 761.523 1218.54 757.5C1220.54 753.477 1223.27 750.375 1226.75 748.193C1230.23 746.011 1234.2 744.92 1238.67 744.92C1241.31 744.92 1243.79 745.304 1246.11 746.071C1248.44 746.838 1250.55 747.963 1252.42 749.446C1254.3 750.912 1255.87 752.702 1257.13 754.815C1258.39 756.912 1259.26 759.307 1259.74 762ZM1267.12 751.261V745.636H1306.39V751.261H1289.92V798H1283.58V751.261H1267.12Z" fill="#CCCCCC"/>
            </g>
            <defs>
            <radialGradient id="paint0_radial_1_2" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(40560 40070) scale(40000)">
            <stop stop-color="white" stop-opacity="0.15"/>
            <stop offset="1" stop-opacity="0"/>
            </radialGradient>
            <linearGradient id="paint1_linear_1_2" x1="800" y1="310" x2="16800" y2="16310" gradientUnits="userSpaceOnUse">
            <stop stop-color="#740001"/>
            <stop offset="1" stop-color="#D00000"/>
            </linearGradient>
            <linearGradient id="paint2_linear_1_2" x1="16960" y1="310" x2="960" y2="16310" gradientUnits="userSpaceOnUse">
            <stop stop-color="#1A472A"/>
            <stop offset="1" stop-color="#2F7A4B"/>
            </linearGradient>
            <linearGradient id="paint3_linear_1_2" x1="16960" y1="16470" x2="960" y2="470" gradientUnits="userSpaceOnUse">
            <stop stop-color="#0E1A40"/>
            <stop offset="1" stop-color="#2C3E75"/>
            </linearGradient>
            <linearGradient id="paint4_linear_1_2" x1="800" y1="16470" x2="16800" y2="470" gradientUnits="userSpaceOnUse">
            <stop stop-color="#ECB939"/>
            <stop offset="1" stop-color="#F5D76E"/>
            </linearGradient>
            <clipPath id="clip0_1_2">
            <rect width="1920" height="1080" fill="white"/>
            </clipPath>
            </defs>
        </svg>
        
        <h1>SVG to ASS <span class="version">1.0</span></h1>
    </header>

    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <span>Input Source</span>
            </div>

            <div class="toolbar">
                <div>
                    <label>精度 Scale</label>
                    <select id="scaleFactor">
                        <option value="8" selected>8x (\p4 推荐)</option>
                        <option value="16">16x (\p5 极致)</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>Header Tags</label>
                    <input type="text" id="extraTags" value="\fscx1000\fscy1000" placeholder="e.g. \pos(960,540)">
                </div>
                <button id="btnConvert" class="btn-primary">转换 Convert</button>
            </div>

            <textarea id="svgInput" placeholder="在此粘贴 SVG 代码 (包含 <svg> 或 <path>)..."></textarea>
        </div>

        <div class="panel">
            
            <div class="panel-header">
                <span>Result Code</span>
                <button id="btnCopy" class="btn-primary" style="padding: 4px 12px; font-size:12px;">复制 Copy</button>
            </div>
            <textarea id="assOutput" readonly placeholder="Waiting for conversion..."></textarea>

            <div class="panel-header" style="margin-top: 5px;">
                <span>Preview</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <label style="margin:0">BG:</label>
                    <input type="range" min="0" max="100" value="90" id="bgSlider" style="width:60px" title="调整预览背景亮度">
                </div>
            </div>
            <div class="preview-box">
                <div id="previewBg"></div>
                <svg id="svgPreview" class="preview-svg">
                    <path id="assPath" fill="#333" fill-opacity="0.8" stroke="#ff4757" stroke-width="1" stroke-linecap="round"/>
                </svg>
            </div>

        </div>
    </div>

    <div id="toast"></div>

    <div class="author-tag">By NickCollect</div>

    <script>
        window.onerror = function(msg) { showToast("Error: " + msg, 'error'); return false; };

        function showToast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.innerText = msg;
            el.className = type + ' show';
            if(el.timer) clearTimeout(el.timer);
            el.timer = setTimeout(() => { el.className = ''; }, 3000);
        }

        document.getElementById('bgSlider').addEventListener('input', function(e) {
            const val = e.target.value;
            const bg = document.getElementById('previewBg');
            const color = val > 50 ? 255 : 0;
            const opacity = Math.abs(val - 50) / 50;
            bg.style.background = `rgba(${color},${color},${color}, ${opacity})`;
        });

        (function() {
            function arcToBezier(px, py, cx, cy, rx, ry, xAxisRotation, largeArcFlag, sweepFlag) {
                var curves = [];
                if (rx === 0 || ry === 0) return null; 
                var phi = xAxisRotation * (Math.PI / 180);
                var sinPhi = Math.sin(phi), cosPhi = Math.cos(phi);
                var pxp = cosPhi * (px - cx) / 2 + sinPhi * (py - cy) / 2;
                var pyp = -sinPhi * (px - cx) / 2 + cosPhi * (py - cy) / 2;
                if (pxp === 0 && pyp === 0) return [];
                rx = Math.abs(rx); ry = Math.abs(ry);
                var lambda = (pxp * pxp) / (rx * rx) + (pyp * pyp) / (ry * ry);
                if (lambda > 1) { rx *= Math.sqrt(lambda); ry *= Math.sqrt(lambda); }
                var radicant = (rx * rx * ry * ry) - (rx * rx * pyp * pyp) - (ry * ry * pxp * pxp);
                if (radicant < 0) radicant = 0;
                radicant /= (rx * rx * pyp * pyp) + (ry * ry * pxp * pxp);
                radicant = Math.sqrt(radicant) * (largeArcFlag === sweepFlag ? -1 : 1);
                var centerx = radicant * rx / ry * pyp;
                var centery = radicant * -ry / rx * pxp;
                var centerx_orig = cosPhi * centerx - sinPhi * centery + (px + cx) / 2;
                var centery_orig = sinPhi * centerx + cosPhi * centery + (py + cy) / 2;
                var ang1 = Math.atan2((pyp - centery) / ry, (pxp - centerx) / rx);
                var ang2 = Math.atan2((-pyp - centery) / ry, (-pxp - centerx) / rx);
                var angDiff = ang2 - ang1;
                if (sweepFlag === 0 && angDiff > 0) angDiff -= 2 * Math.PI;
                else if (sweepFlag === 1 && angDiff < 0) angDiff += 2 * Math.PI;
                var segments = Math.ceil(Math.abs(angDiff) / (Math.PI / 2));
                var segmentAngle = angDiff / segments;
                var k = (4 / 3) * Math.tan(segmentAngle / 4);
                var currentAng = ang1;
                for (var i = 0; i < segments; i++) {
                    var nextAng = currentAng + segmentAngle;
                    var cos1 = Math.cos(currentAng), sin1 = Math.sin(currentAng);
                    var cos2 = Math.cos(nextAng), sin2 = Math.sin(nextAng);
                    var p1x = rx * (cos1 - k * sin1), p1y = ry * (sin1 + k * cos1);
                    var p2x = rx * (cos2 + k * sin2), p2y = ry * (sin2 - k * cos2);
                    var p3x = rx * cos2, p3y = ry * sin2;
                    curves.push({
                        x1: centerx_orig + cosPhi * p1x - sinPhi * p1y, y1: centery_orig + sinPhi * p1x + cosPhi * p1y,
                        x2: centerx_orig + cosPhi * p2x - sinPhi * p2y, y2: centery_orig + sinPhi * p2x + cosPhi * p2y,
                        x: centerx_orig + cosPhi * p3x - sinPhi * p3y, y: centery_orig + sinPhi * p3x + cosPhi * p3y
                    });
                    currentAng = nextAng;
                }
                return curves;
            }

            class SVGParser {
                constructor(pathStr) {
                    this.tokens = pathStr.match(/([a-zA-Z])|([-+]?(?:\d+\.?\d*|\.\d+)(?:[eE][-+]?\d+)?)/g) || [];
                    this.index = 0;
                    this.penX = 0; this.penY = 0;
                    this.startX = 0; this.startY = 0;
                    this.lastControlX = 0; this.lastControlY = 0;
                    this.lastCommand = '';
                }
                nextNum() { return this.index < this.tokens.length ? parseFloat(this.tokens[this.index++]) : 0; }
                isCommand(t) { return /^[a-zA-Z]$/.test(t); }
                parse() {
                    var commands = [];
                    this.index = 0;
                    var currentCommand = '';
                    while (this.index < this.tokens.length) {
                        var token = this.tokens[this.index];
                        if (this.isCommand(token)) {
                            currentCommand = token;
                            this.index++;
                        } else {
                            if (currentCommand === 'M') currentCommand = 'L';
                            if (currentCommand === 'm') currentCommand = 'l';
                        }
                        var cmds = this.processCommand(currentCommand);
                        if (cmds) commands.push(...cmds);
                        this.lastCommand = currentCommand;
                    }
                    return commands;
                }
                processCommand(cmd) {
                    var result = [];
                    var cX, cY;
                    const isRel = (c) => c === c.toLowerCase();
                    try {
                        switch (cmd) {
                            case 'M': case 'm': 
                                var x = this.nextNum(), y = this.nextNum();
                                if (isRel(cmd)) { x += this.penX; y += this.penY; }
                                this.penX = x; this.penY = y; this.startX = x; this.startY = y;
                                result.push({type:'M',x:x,y:y}); cX=x; cY=y; break;
                            case 'L': case 'l': case 'H': case 'h': case 'V': case 'v':
                                var x = this.penX, y = this.penY;
                                if (cmd.toLowerCase() === 'h') { x = this.nextNum(); if(isRel(cmd)) x += this.penX; } 
                                else if (cmd.toLowerCase() === 'v') { y = this.nextNum(); if(isRel(cmd)) y += this.penY; } 
                                else { x = this.nextNum(); y = this.nextNum(); if(isRel(cmd)){ x += this.penX; y += this.penY; } }
                                this.penX = x; this.penY = y;
                                result.push({type:'L',x:x,y:y}); cX=x; cY=y; break;
                            case 'C': case 'c': 
                                var x1=this.nextNum(), y1=this.nextNum(), x2=this.nextNum(), y2=this.nextNum(), x=this.nextNum(), y=this.nextNum();
                                if (isRel(cmd)){ x1+=this.penX; y1+=this.penY; x2+=this.penX; y2+=this.penY; x+=this.penX; y+=this.penY; }
                                result.push({type:'C',x1:x1,y1:y1,x2:x2,y2:y2,x:x,y:y}); 
                                this.penX=x; this.penY=y; cX=x2; cY=y2; break;
                            case 'S': case 's': 
                                var x2=this.nextNum(), y2=this.nextNum(), x=this.nextNum(), y=this.nextNum();
                                if (isRel(cmd)){ x2+=this.penX; y2+=this.penY; x+=this.penX; y+=this.penY; }
                                var x1 = (['C','c','S','s'].includes(this.lastCommand)) ? 2*this.penX - this.lastControlX : this.penX;
                                var y1 = (['C','c','S','s'].includes(this.lastCommand)) ? 2*this.penY - this.lastControlY : this.penY;
                                result.push({type:'C',x1:x1,y1:y1,x2:x2,y2:y2,x:x,y:y}); 
                                this.penX=x; this.penY=y; cX=x2; cY=y2; break;
                            case 'Q': case 'q': 
                                var x1=this.nextNum(), y1=this.nextNum(), x=this.nextNum(), y=this.nextNum();
                                if(isRel(cmd)){x1+=this.penX; y1+=this.penY; x+=this.penX; y+=this.penY;}
                                var cp1x=this.penX+(2/3)*(x1-this.penX), cp1y=this.penY+(2/3)*(y1-this.penY);
                                var cp2x=x+(2/3)*(x1-x), cp2y=y+(2/3)*(y1-y);
                                result.push({type:'C',x1:cp1x,y1:cp1y,x2:cp2x,y2:cp2y,x:x,y:y}); 
                                this.penX=x; this.penY=y; cX=x1; cY=y1; break;
                            case 'T': case 't': 
                                var x=this.nextNum(), y=this.nextNum();
                                if(isRel(cmd)){x+=this.penX; y+=this.penY;}
                                var x1 = (['Q','q','T','t'].includes(this.lastCommand)) ? 2*this.penX - this.lastControlX : this.penX;
                                var y1 = (['Q','q','T','t'].includes(this.lastCommand)) ? 2*this.penY - this.lastControlY : this.penY;
                                var cp1x=this.penX+(2/3)*(x1-this.penX), cp1y=this.penY+(2/3)*(y1-this.penY);
                                var cp2x=x+(2/3)*(x1-x), cp2y=y+(2/3)*(y1-y);
                                result.push({type:'C',x1:cp1x,y1:cp1y,x2:cp2x,y2:cp2y,x:x,y:y}); 
                                this.penX=x; this.penY=y; cX=x1; cY=y1; break;
                            case 'A': case 'a': 
                                var rx=this.nextNum(), ry=this.nextNum(), rot=this.nextNum(), laf=this.nextNum(), sf=this.nextNum(), x=this.nextNum(), y=this.nextNum();
                                if(isRel(cmd)){x+=this.penX; y+=this.penY;}
                                var curves = arcToBezier(this.penX, this.penY, x, y, rx, ry, rot, laf===1, sf===1);
                                if (!curves) result.push({type:'L',x:x,y:y});
                                else curves.forEach(function(c) { result.push({type:'C',x1:c.x1,y1:c.y1,x2:c.x2,y2:c.y2,x:c.x,y:c.y}); });
                                this.penX=x; this.penY=y; cX=x; cY=y; break;
                            case 'Z': case 'z': 
                                this.penX=this.startX; this.penY=this.startY;
                                result.push({type:'L',x:this.startX,y:this.startY}); cX=this.startX; cY=this.startY; break;
                        }
                    } catch(e) { console.warn(e); }
                    this.lastControlX = cX; this.lastControlY = cY;
                    return result;
                }
            }

            function extractPathData(htmlStr) {
                if (!htmlStr.includes('<') && !htmlStr.includes('>') && !htmlStr.includes('=')) return htmlStr; 
                var matches = [];
                var regex = /d\s*=\s*["']([^"']+)["']/gi;
                var match;
                while ((match = regex.exec(htmlStr)) !== null) { matches.push(match[1]); }
                if (matches.length > 0) {
                    showToast("智能合并 " + matches.length + " 条路径。", 'success');
                    return matches.join(' ');
                }
                showToast("未检测到标准 SVG 格式，尝试强制解析...", 'warn');
                return htmlStr; 
            }

            var btn = document.getElementById('btnConvert');
            var btnCopy = document.getElementById('btnCopy');

            btn.addEventListener('click', function() {
                try {
                    var rawInput = document.getElementById('svgInput').value.trim();
                    if(!rawInput) { showToast("请输入 SVG 代码", 'warn'); return; }

                    var cleanInput = extractPathData(rawInput);
                    var scale = parseFloat(document.getElementById('scaleFactor').value);
                    var extraTags = document.getElementById('extraTags').value.trim();
                    
                    var parser = new SVGParser(cleanInput);
                    var absCommands = parser.parse();

                    if(absCommands.length === 0) {
                        showToast("无效的路径数据", 'error');
                        return;
                    }

                    var minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    var updateBounds = function(x, y) {
                        if (x < minX) minX = x; if (x > maxX) maxX = x;
                        if (y < minY) minY = y; if (y > maxY) maxY = y;
                    };
                    
                    var assStr = "";
                    var f = function(n) { return Math.round(n * scale); };

                    absCommands.forEach(function(c) {
                        if (c.type === 'M') { assStr += "m " + f(c.x) + " " + f(c.y) + " "; updateBounds(c.x, c.y); }
                        if (c.type === 'L') { assStr += "l " + f(c.x) + " " + f(c.y) + " "; updateBounds(c.x, c.y); }
                        if (c.type === 'C') { 
                            assStr += "b " + f(c.x1) + " " + f(c.y1) + " " + f(c.x2) + " " + f(c.y2) + " " + f(c.x) + " " + f(c.y) + " "; 
                            updateBounds(c.x1, c.y1); updateBounds(c.x2, c.y2); updateBounds(c.x, c.y);
                        }
                    });

                    document.getElementById('assPath').setAttribute('d', cleanInput);
                    var w = maxX - minX; var h = maxY - minY;
                    if (w <= 0) w = 100; if (h <= 0) h = 100;
                    var padding = Math.max(w, h) * 0.1;
                    var vb = (minX - padding) + " " + (minY - padding) + " " + (w + padding*2) + " " + (h + padding*2);
                    document.getElementById('svgPreview').setAttribute('viewBox', vb);

                    var pMap = {1:'\\p1', 4:'\\p3', 8:'\\p4', 16:'\\p5'};
                    var pTag = pMap[scale] || '\\p1';
                    var head = "{" + extraTags + pTag + "}";
                    document.getElementById('assOutput').value = head + assStr.trim() + "{\\p0}";
                    
                    if (!rawInput.includes('<')) showToast("转换成功!", 'success');

                } catch (e) {
                    showToast(e.message, 'error');
                }
            });

            btnCopy.addEventListener('click', function() {
                var el = document.getElementById('assOutput');
                el.select();
                if(document.execCommand('copy')){
                    showToast("ASS 代码已复制", 'success');
                }
            });
        })();
    </script>
</body>
</html>